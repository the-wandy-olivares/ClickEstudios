{% extends "citas/base/base.html" %}
{% block content %}
{% load humanize %}
<style>
      tbody td
      {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.761);
      }
      .cj 
      {
            font-size: 14px;
      }
      .ps312 p
      {
        margin: 0.2rem !important; 
        text-align: center !important;
        
      }
      .ps312 
      {
        font-size: 14px;
      }
      strong
        {
                font-size: 14px;
                font-weight: 500; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
</style>
<section class='  bg-black bg-opacity-50 overflow-scroll '  >
      {% include "citas/components/nav.html" %}
      <div class="   align-content-start" style='height: 93vh;'>
        
            <section data-aos="fade-up" class="d-flex overflow-scroll justify-content-center  flex-wrap " >
           
                <div class="w-100 d-flex justify-content-start flex-wrap">
                    <h2 class="accordion-header w-100" id="headingTwo">
                        <button class="accordion-button collapsed  p-2 rounded-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo3" aria-expanded="true" aria-controls="collapseTwo3" style="width: max-content;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-ui-checks-grid me-1" viewBox="0 0 16 16">
                                <path d="M2 10h3a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1m9-9h3a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-3a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 9a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1zm0-10a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h3a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM2 9a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h3a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2zm7 2a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-3a2 2 0 0 1-2-2zM0 2a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm5.354.854a.5.5 0 1 0-.708-.708L3 3.793l-.646-.647a.5.5 0 1 0-.708.708l1 1a.5.5 0 0 0 .708 0z"/>
                              </svg> Control de caja
                        </button>
                      </h2>
                      <p class="text-white-50 p-0 ps-2" style="font-size: 12px;">
                        Ayuda a garantizar que el dinero en efectivo y las transacciones coincidan con las ventas registradas. 
                        </p>
                </div>


                <div class="card-body d-flex w-100 overflow-scroll">
                    <div class="w-100 d-flex justify-content-start  ">
                            {% if cash_register.status == 'open' %}
                            <div class='text-start me-3 d-flex ps312'>
                                    <p class="p-0 m-0  bg-white bg-opacity-10 rounded-4 p-1" style="width: 11rem; height: max-content;">
                                        <strong> #{{ cash_register.id }}</strong> 
                                        <span class="text-white-50">
                                            - Estado: {{ cash_register.get_status_display }}</span>
                                    </p>
                                    <p class="p-0 m-0  bg-white bg-opacity-10 rounded-4 p-1" style="width: 15rem; height: max-content;">
                                        <strong>Balance de Aper..</strong> 
                                        <span class="text-white-50"> $ {{ cash_register.opening_balance|intcomma }}</span> 
                                    </p>
                                    <p class="p-0 m-0  bg-white bg-opacity-10 rounded-4 p-1" style="width: 16rem; height: max-content;">
                                        <strong>Apertura:</strong>  
                                        <span class="text-white-50">{{ cash_register.opened_at|date:"d/m/Y" }} 
                                        por {{ cash_register.opened_by }}</span> 
                                    </p>
                                    <p class="p-0 m-0  bg-white bg-opacity-10 rounded-4 p-1" style="width: 9rem; height: max-content;">
                                        <strong>Ingresos</strong>
                                        <span class="text-white-50"> ${{count_ingresos|intcomma}} </span>
                                    </p>
                                    <p class="p-0 m-0  bg-white bg-opacity-10 rounded-4 p-1" style="width: 9rem; height: max-content;">
                                        <strong>Gastos</strong>
                                        <span class="text-white-50"> ${{count_gastos|intcomma}} </span>
                                    </p>
                                    <p class="p-0 m-0  bg-white bg-opacity-10 rounded-4 p-1" style="width: 14rem; height: max-content;">
                                        <strong>Balance en caja</strong>
                                        <span class="text-white-50">  ${{count_ingresos|intcomma}}</span>
                                    </p>
                            
                            </div>
                        {% else %}
                            <div style='width: 100%;' class='text-start ms-3 p-2  ps-4 bg-white bg-opacity-10 rounded-4 '>
                            
                                <h6 class="card-title p-0  m-0 "> 
                                    <strong> Caja :</strong>
                                        <span class="text-white-50"> #{{ cash_register_last.id }}
                                                {{ cash_register_last.get_status_display }}
                                        </span>
                                </h6>
                                <p class="p-0 m-0"> 
                                    <strong>Cerrado por:</strong>
                                    <span class="text-white-50 text-capitalize" >  {{ cash_register_last.closed_by }}  </span>
                                    </p>
                                <p class="p-0 m-0"> 
                                    <strong>Balance de Apertura:</strong> 
                                    <span class="text-white-50"> $ {{ cash_register_last.opening_balance|intcomma }}</span>
                                    </p>
                                <p class="p-0 m-0"> 
                                    <strong>Balance de Cierre:</strong>
                                    <span class="text-white-50">$ {{ cash_register_last.closing_balance|intcomma }}</span> 
                                </p>
                                <p>
                                        <strong > Ultimo cierre 
                                            <span class='text-white-50'>        
                                                {{cash_register_last.closed_at}}
                                            </span>
                                        </strong> 
                                    </p>
                            
                            </div>

                        <div class=' w-100 mt-0 ms-3'>
                            <form method="post"  class=''>
                                {% csrf_token %}
                                <div class="form-group" style='width: 300px;'>
                                    <label for="opening_balance">Monto de Apertura</label>
                                    <p class='text-white-50' style='font-size: 12px; line-height: 8px;'>
                                        Indica la cantidad de dinero con la que se inicia la caja al comenzar un turno o un día de trabajo
                                    </p>
                                    <input type="number" value="{{ cash_register_last.closing_balance}}" class=" form-control w-100 text-white bg-white bg-opacity-10 rounded-4 border-0"  name="opening_balance" step="0.01" required>
                                </div>
                                <button type="submit" name="open_cash" class="btn bg-white bg-opacity-10 ps-4 pe-4 rounded-4 mt-2 text-white" 
                                    style="font-size: 14px;">Abrir nueva caja
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    <div class="w-100">

                        {% if cash_register.status == 'open' %}
                        <form method="post" class="mt-0">
                                {% csrf_token %}
                                <div class="form-group" style='width: 400px;'>
                  
                                <input type="number" class="form-control d-none w-100 text-white bg-white bg-opacity-10 rounded-4 border-0" name="closing_balance"   step="0.01" value="{{count_ingresos}}" required style="">
                            </div>
                            <button type="submit" name="close_cash" class="btn bg-danger bg-opacity-25 rounded-5  text-white ps-4 pe-4" 
                            style="font-size: 14px;"> 
                                Cerrar Caja
                            </button>
                        </form>
                        
                        {% else %}

                        {% endif %}
                    </div>
                </div>

                <section class=' bg-white bg-opacity-10 p-3 rounded-4 m-2 mt-0 w-100 overflow-auto'          
                style="
                height: calc(100vh - 15rem);
                 ">
                    <table class="w-100">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Descripción</th>
                                <th>Ingreso</th>
                                <th>Gasto</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.id }}</td>
                                <td>{{ record.date|date:"d/m/Y" }}</td>
                                <td>{{ record.name }}</td>
                                <td>{{ record.description|intcomma }}</td>
                                <td> 
                                    {% if record.ingreso %}
                                        ${{ record.ingreso|intcomma }}
                                    {% endif %}
                                
                                </td>
                                <td>
                                    {% if record.gasto %}
                                        ${{ record.gasto|intcomma }}
                                    {% endif %}
                                
                                </td>

                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center pt-4">
                                    <strong>No hay registros financieros disponibles</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </section>
                <div class="d-flex  w-100 justify-content-end  p-2 pb-0">
                    <a href="{% url "citas:financial-record-create" %}">  
                        <button class="btn text-white rounded-5  bg-primary bg-opacity-25   me-2" 
                            style="font-size: 14px; margin-top: 2px;"> 
                             Listado de gastos
                        </button> 
                    </a> 
                    <form action="" method="post" class="d-flex">
                        {% csrf_token %}
                        <select class="form-select select-3 bg-white bg-opacity-10 text-white border-0 rounded-3 me-2" aria-label="Seleccionar año" style="width: max-content;">
                            {% for year in years %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                                    {{ year }}
                                </option>
                            {% endfor %}
                        </select>
                    
                        <select class="form-select select-1  bg-white bg-opacity-10 text-white border-0 rounded-3 me-2" aria-label="Seleccionar mes" style="width: max-content;">
                            {% for month in months %}
                                <option value="{{ month.value }}" {% if month.value == current_month %}selected{% endif %}>
                                {{ month.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <select class="form-select select-2  bg-white bg-opacity-10 text-white border-0 rounded-3 me-2" aria-label="Seleccionar mes" style="width: max-content;">
                            {% for month in months %}
                                <option value="{{ month.value }}" {% if month.value == current_month %}selected{% endif %}>
                                  {{ month.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <button class="btn text-white rounded-5  bg-white bg-opacity-10 me-2"> 
                            Filtrar
                        </button>
                    </form>
                </div>
  
                <div data-aos="fade-up" class="accordion-item d-none m-1 mt-0 w-100 ">
                        <h2 class="accordion-header" id="headingTwo">
                          <button class="accordion-button collapsed  p-2 rounded-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo3" aria-expanded="true" aria-controls="collapseTwo3" style="width: max-content;">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-ui-checks m-1" viewBox="0 0 16 16">
                                    <path d="M7 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5zM2 1a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm0 8a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2zm.854-3.646a.5.5 0 0 1-.708 0l-1-1a.5.5 0 1 1 .708-.708l.646.647 1.646-1.647a.5.5 0 1 1 .708.708zm0 8a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.646.647 1.646-1.647a.5.5 0 0 1 .708.708zM7 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5zm0-5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0 8a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                                  </svg>   Historial de caja
                          </button>
                        </h2>
                        <p class="text-white-50 p-0 ps-2" style="font-size: 12px;  line-height: 8px">
                            Garantiza un registro claro y accesible de todas las operaciones para evitar fraudes o errores.
                          </p>
                        <div id="collapseTwo3"  class="w-100 accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                          <div class="accordion-body">
                              <div   style="height: 20rem;" class="   bg-white bg-opacity-10 rounded-4 p-3 m-1 overflow-scroll " >
                                    <!-- Tabla de registros de caja -->
                                    <table class=" w-100">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Apertura</th>
                                                <th>Cierre</th>
                                                <th>Abierto Por</th>
                                                <th>Cerrado Por</th>
                                                <th>Balance de Apertura</th>
                                                <th>Balance de Cierre</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for cash_r in cash_registers %}
                                            <tr>
                                                <td>{{ cash_r.id }}</td>
                                                <td>{{ cash_r.opened_at|date:"d/m/Y H:i" }}</td>
                                                <td>{% if cash_r.closed_at %}{{ cash_r.closed_at|date:"d/m/Y H:i" }}{% else %}N/A{% endif %}</td>
                                                <td class='text-capitalize'>{{ cash_r.opened_by.username }}</td>
                                                <td class='text-capitalize'>{% if cash_r.closed_by %}{{ cash_r.closed_by.username }}{% else %}N/A{% endif %}</td>
                                                <td>RD$ {{ cash_r.opening_balance|intcomma}}</td>
                                                <td>{% if cash_r.closing_balance %}RD$ {{ cash_r.closing_balance|intcomma }}{% else %}N/A{% endif %}</td>
                                                <td>{{ cash_r.get_status_display }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                    <td colspan="8" class="text-center pt-4">
                                                            <strong>
                                                                No hay registros de caja disponibles
                                                            </strong>
                                                    </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                          </div>
                        </div>
                  </div>
            </section>
            
            <div class="rounded-1 m-1 p-2   " >

     

                  <!-- Mostrar información de la caja -->
                  <section  class="w-100  d-flex ">
                      <div class="card bg-transparent   border-0 cj w-100 text-white  " 
                          style=" border-radius: 1rem;">
                        
                      </div>
                  </section>
            </div>
      </div>
</section>

<script>
      TextSession('Control de caja')
      window.onload = function() {
            // Selecciona todos los elementos con la clase 'collapsed'
            // var collapsedElements = document.querySelectorAll('.collapsed');
            
            // Itera sobre los elementos y simula un clic en cada uno
            collapsedElements.forEach(function(element) {
                element.click();
            });
        };

</script>

{% endblock  %}